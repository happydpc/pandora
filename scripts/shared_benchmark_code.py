import subprocess
import os
import shutil

torque_exe = "C:/Users/Mathijs/Documents/GitHub/pandora/out/build/x64-Release/torque.exe"
files_of_interest = ["output.jpg", "stats.json", "stream_stats.json"]


def run_pandora(arguments, out_folder):
    pandora_path = os.path.dirname(torque_exe)

    # Remove files of interest so we don't accidentaly copy over junk files if the Pandora crashes but returns exit code 0
    for filename in files_of_interest:
        filepath = os.path.join(pandora_path, filename)
        if os.path.exists(filepath):
            os.remove(filepath)

    try:
        output = subprocess.check_output(
            [torque_exe] + [str(arg) for arg in arguments], cwd=pandora_path)
    except Exception as e:
        print(f"Error running pandora:\n{e}")
        return

    if not os.path.exists(out_folder):
        os.makedirs(out_folder)

    try:
        # Store the output (cout) to the output folder
        with open(os.path.join(out_folder, "cout.txt"), "w", newline='') as f:
            f.write(output.decode("utf-8"))

        # Copy files generated by Pandora (like stats & final image) to the output folder
        for filename in files_of_interest:
            shutil.copyfile(os.path.join(pandora_path, filename),
                            os.path.join(out_folder, filename))
    except Exception as e:
        print(f"Error copying results:\n{e}")
        return


def get_scenes():
    return [
        {
            "name": "landscape",
            "file": "F:/Pandora Scenes/PBF/landscape-view0.pbf",
            "subdiv": 0,
            # 4330M total / 25M unique primitives => 335 batching points
            "batch_point_size": 20000000,
            "max_geom_mem_mb": 860,  # 0.86GB => 859132556 bytes
            "max_bvh_mem_mb": 1380  # 1.38GB => 2868202912 - 1488687008 = 1379515904 bytes
        }
    ]
    return [
        {
            "name": "crown",
            "file": "F:/Pandora Scenes/PBF/crown.pbf",
            "subdiv": 3,
            "batch_point_size": 10000000,  # 860M primitives => 132 batching points
            "max_geom_mem_mb": 20706,  # 20.7GB => 20705820432 bytes
            "max_bvh_mem_mb": 6250  # 6.25GB => 11484004352 - 5234491392 = 6249512960 bytes
        },
        {
            "name": "island",
            "file": "F:/Pandora Scenes/PBF/island.pbf",
            "subdiv": 0,
            "batch_point_size": 100000000,  # => 504 batching points
            "max_geom_mem_mb": 8217,  # 8.217GB => 8216115664 bytes
            "max_bvh_mem_mb": 8649  # 8.649GB => 22402346496 - 13753576064 = 8648770432 bytes
        }
    ]
