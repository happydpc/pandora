import subprocess
import os
import shutil

torque_exe = "C:/Users/Mathijs/Documents/GitHub/pandora/out/build/x64-Release/torque.exe"
files_of_interest = ["output.jpg", "num_top_level_intersections.exr", "stats.json"]


def run_pandora(arguments, out_folder):
    pandora_path = os.path.dirname(torque_exe)

    # Remove files of interest so we don't accidentaly copy over junk files if the Pandora crashes but returns exit code 0
    for filename in files_of_interest:
        filepath = os.path.join(pandora_path, filename)
        if os.path.exists(filepath):
            os.remove(filepath)

    try:
        output = subprocess.check_output(
            [torque_exe] + [str(arg) for arg in arguments], cwd=pandora_path)
    except Exception as e:
        print(f"Error running pandora:\n{e}")
        return

    if not os.path.exists(out_folder):
        os.makedirs(out_folder)

    try:
        # Store the output (cout) to the output folder
        with open(os.path.join(out_folder, "cout.txt"), "w", newline='') as f:
            f.write(output.decode("utf-8"))

        # Copy files generated by Pandora (like stats & final image) to the output folder
        for filename in files_of_interest:
            shutil.copyfile(os.path.join(pandora_path, filename),
                            os.path.join(out_folder, filename))
    except Exception as e:
        print(f"Error copying results:\n{e}")
        return


def get_scenes():
    return [
        {
            "name": "crown",
            "file": "F:/Pandora Scenes/PBF/crown-pbf11.pbf",
            "subdiv": 4,
            "batch_point_size": 8100000, # 8.1M => 56 batching points
            "max_geom_mem_mb": 6318,  # 6.318GB => 6.317.216.528 bytes
            "max_bvh_mem_mb": 11423,  # 11.423GB => 11.422.434.688‬ bytes
            "svdag_mem_usage128": 3618552 # 3.618.552 bytes after compression
        },
        {
            "name": "landscape",
            "file": "F:/Pandora Scenes/PBF/landscape-view0-halfres-pbf11.pbf",
            "subdiv": 2,
            "batch_point_size": 15000000, # 15M => 104 batching points
            "max_geom_mem_mb": 6259,  # 6.259GB => 6.258.291.948‬ bytes
            "max_bvh_mem_mb": 12062,  # 12.062GB => 12.061.364.864 bytes
            "svdag_mem_usage128": 6175304 # 6.140.944 bytes after compression
        },
        {
            "name": "island",
            "file": "F:/Pandora Scenes/PBF/island-pbf11.pbf",
            "subdiv": 0,
            "batch_point_size": 7500000,  # 7.5M => 547 batching points
            "max_geom_mem_mb": 8451,  # 8.451GB => 8.450.315.056 bytes
            "max_bvh_mem_mb": 9781,   # 9.781GB => 9.780.193.280‬ bytes
            "svdag_mem_usage128": 23616392 # 23.616.392 bytes after compression
        }
    ]
